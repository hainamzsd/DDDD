# Validation Guide - LocationID Tracker (C06)

This document describes all validation rules implemented in the LocationID Tracker app to ensure regulatory compliance with Vietnamese land and cadastral regulations.

## Overview

The app implements comprehensive validation for all user inputs to ensure:
- **Data accuracy**: All data meets format and content requirements
- **Regulatory compliance**: Adheres to Vietnamese land law and cadastral regulations
- **Data quality**: Prevents invalid or nonsensical data from being submitted
- **User guidance**: Clear error messages in Vietnamese to help users correct mistakes

## Validation Module

**Location**: `utils/validation.ts`

All validation functions return a `ValidationResult` object:
```typescript
interface ValidationResult {
  isValid: boolean;
  errorMessage?: string; // Vietnamese error message if invalid
}
```

## Implemented Validations

### 1. Location Identifier (Mã định danh)

**Function**: `validateLocationIdentifier(identifier: string)`

**Format**: `PP-DD-CC-NNNNNN`
- **PP**: Province code (01-96)
- **DD**: District code (01-99)
- **CC**: Commune code (01-99)
- **NNNNNN**: Sequential number (000001-999999)

**Example**: `79-02-05-000123` (Hồ Chí Minh, Quận 1, Phường Bến Nghé, #123)

**Validation Rules**:
- ✅ Must match exact format with hyphens
- ✅ Province code must be 01-96
- ✅ District code must be 01-99
- ✅ Commune code must be 01-99
- ✅ Sequential number must be 000001-999999

**Error Messages**:
- "Mã định danh không được để trống"
- "Mã định danh phải theo định dạng PP-DD-CC-NNNNNN (ví dụ: 79-02-05-000123)"
- "Mã tỉnh/thành phố không hợp lệ (phải từ 01-96)"
- "Mã quận/huyện không hợp lệ (phải từ 01-99)"
- "Mã phường/xã không hợp lệ (phải từ 01-99)"
- "Số thứ tự không hợp lệ (phải từ 000001-999999)"

**Where Used**: Auto-generated by database trigger, not user-facing

---

### 2. Land Use Type Code (Mã loại đất)

**Function**: `validateLandUseTypeCode(code: string)`

**Format**: Valid prefixes per Vietnamese cadastral categories
- **NNG.***: Nông nghiệp (Agricultural)
- **PNN.***: Phi nông nghiệp (Non-agricultural)
- **CSD.***: Chưa sử dụng (Unused)

**Examples**:
- `NNG.LUA` - Đất trồng lúa
- `PNN.DO.TT` - Đất đô thị
- `PNN.SXKD.CN` - Đất sản xuất kinh doanh công nghiệp

**Validation Rules**:
- ✅ Must start with NNG., PNN., or CSD.
- ✅ Must match pattern: `[A-Z]{3}(\.[A-Z0-9]+)+`
- ✅ Cannot be empty

**Error Messages**:
- "Loại sử dụng đất không được để trống"
- "Mã loại đất phải bắt đầu bằng NNG., PNN., hoặc CSD."
- "Mã loại đất không đúng định dạng (ví dụ: NNG.LUA, PNN.DO.TT)"

**Where Used**: `UsageInfoScreen` (screen 8)

---

### 3. Administrative Unit Code (Mã đơn vị hành chính)

**Function**: `validateAdminUnitCode(code: string, level: 'province' | 'district' | 'commune')`

**Formats by Level**:
- **Province**: `PP` (2 digits, 01-96)
- **District**: `PP-DD` (hyphen-separated)
- **Commune**: `PP-DD-CC` (hyphen-separated)

**Examples**:
- `79` - TP Hồ Chí Minh
- `79-02` - Quận 1
- `79-02-05` - Phường Bến Nghé

**Validation Rules**:
- ✅ Must match format for specified level
- ✅ Province code: 01-96
- ✅ District code: 01-99
- ✅ Commune code: 01-99

**Error Messages**:
- "Mã đơn vị hành chính không được để trống"
- "Mã không đúng định dạng. Phải theo dạng {format}"
- "Mã tỉnh/thành phố không hợp lệ (phải từ 01-96)"
- "Mã quận/huyện không hợp lệ (phải từ 01-99)"
- "Mã phường/xã không hợp lệ (phải từ 01-99)"

**Where Used**: Reference data validation (not directly user-facing)

---

### 4. Owner ID Number (Số CMND/CCCD)

**Function**: `validateOwnerIdNumber(idNumber: string)`

**Formats**:
- **CMND (old)**: 9 digits
- **CCCD (new)**: 12 digits

**CCCD Format (Circular 01/2022/TT-BCA)**:
- **ABC**: Mã địa bàn nơi sinh (3 digits)
- **D**: Giới tính và thế kỷ sinh (1 digit)
- **E**: Năm cuối của năm sinh (1 digit)
- **FGHIJK**: Số ngẫu nhiên (6 digits)

**Validation Rules**:
- ✅ Must be all digits
- ✅ Length must be exactly 9 or 12 digits
- ✅ Spaces and hyphens are removed before validation

**Error Messages**:
- "Số CMND/CCCD không được để trống"
- "Số CMND/CCCD chỉ được chứa chữ số"
- "Số CMND/CCCD phải có 9 chữ số (CMND cũ) hoặc 12 chữ số (CCCD mới)"

**Where Used**: `OwnerInfoScreen` (screen 6)

---

### 5. Phone Number (Số điện thoại)

**Function**: `validatePhoneNumber(phoneNumber: string)`

**Format**: 10 digits starting with valid prefix

**Valid Prefixes**:
- `02` - Landline
- `03` - Mobile (Viettel, MobiFone, VinaPhone)
- `05` - Mobile (Vietnamobile)
- `07` - Mobile (Viettel, MobiFone)
- `08` - Mobile (VinaPhone)
- `09` - Mobile (MobiFone, Viettel)

**Validation Rules**:
- ✅ Optional field (returns valid if empty)
- ✅ Must be all digits (after removing formatting)
- ✅ Must be exactly 10 digits
- ✅ Must start with valid prefix

**Error Messages**:
- "Số điện thoại chỉ được chứa chữ số"
- "Số điện thoại phải có 10 chữ số"
- "Số điện thoại phải bắt đầu bằng 02, 03, 05, 07, 08, hoặc 09"

**Where Used**: Future enhancement (not yet in UI)

---

### 6. Land Certificate Number (Số GCN QSDĐ)

**Function**: `validateLandCertificateNumber(certNumber: string)`

**Format**: Variable by province and year (alphanumeric with /, -)

**Examples**:
- `BG123456/2023`
- `79-2023-000123`
- `HCM/2023/123456`

**Validation Rules**:
- ✅ Optional field (returns valid if empty)
- ✅ Length: 5-30 characters
- ✅ Only letters, numbers, /, -, and spaces allowed

**Error Messages**:
- "Số GCN phải có độ dài từ 5-30 ký tự"
- "Số GCN chỉ được chứa chữ cái, số, dấu /, và dấu -"

**Where Used**: Future enhancement (not yet in UI)

---

### 7. Area Values (Diện tích)

**Function**: `validateArea(area: number | string, fieldName: string)`

**Range**: 1 - 1,000,000 m²

**Validation Rules**:
- ✅ Optional field (returns valid if empty)
- ✅ Must be a positive number
- ✅ Maximum 2 decimal places
- ✅ Reasonable range (1 - 1,000,000 m²)

**Error Messages**:
- "{fieldName} phải là số"
- "{fieldName} phải lớn hơn 0"
- "{fieldName} không được vượt quá 1,000,000 m²"
- "{fieldName} chỉ được có tối đa 2 chữ số thập phân"

**Where Used**: Future enhancement (not yet in UI)

---

### 8. GPS Coordinates (Tọa độ GPS)

**Function**: `validateGPSCoordinates(latitude: number, longitude: number)`

**Vietnam Boundaries**:
- **Latitude**: 8.5°N - 23.4°N
- **Longitude**: 102.1°E - 109.5°E

**Validation Rules**:
- ✅ Required (cannot be null/undefined)
- ✅ Must be valid numbers
- ✅ Must fall within Vietnam's geographical boundaries

**Error Messages**:
- "Tọa độ GPS không được để trống"
- "Tọa độ GPS không hợp lệ"
- "Vĩ độ phải nằm trong khoảng 8.5°N - 23.4°N (phạm vi Việt Nam)"
- "Kinh độ phải nằm trong khoảng 102.1°E - 109.5°E (phạm vi Việt Nam)"

**Where Used**: `GPSCaptureScreen` (screen 4)

---

### 9. Polygon Vertices (Điểm đa giác)

**Function**: `validatePolygonVertices(vertices: Array<{latitude, longitude}>)`

**Requirements**: Minimum 3 points for valid polygon

**Validation Rules**:
- ✅ Optional (returns valid if empty)
- ✅ Minimum 3 points if provided
- ✅ Each vertex must have valid GPS coordinates (within Vietnam)

**Error Messages**:
- "Đa giác phải có ít nhất 3 điểm"
- "Điểm {n}: {coordinate error message}"

**Where Used**: `PolygonDrawScreen` (screen 9)

---

### 10. Required Text Fields (Trường văn bản bắt buộc)

**Function**: `validateRequiredText(value: string, fieldName: string, minLength: number, maxLength: number)`

**Default Limits**:
- **minLength**: 1 character
- **maxLength**: 500 characters

**Validation Rules**:
- ✅ Cannot be empty or whitespace-only
- ✅ Must meet minimum length (after trimming)
- ✅ Must not exceed maximum length

**Error Messages**:
- "{fieldName} không được để trống"
- "{fieldName} phải có ít nhất {minLength} ký tự"
- "{fieldName} không được vượt quá {maxLength} ký tự"

**Where Used**:
- `OwnerInfoScreen`: location name, house number, street name, owner name
- Various other screens for text inputs

---

## Integration in Screens

### Screen-by-Screen Validation

| Screen | Validated Fields | Validation Functions Used |
|--------|------------------|---------------------------|
| **LoginScreen** | Police ID (12 digits) | Custom regex (similar to ID validation) |
| **StartSurveyScreen** | Object type, Object ID | Custom validation |
| **GPSCaptureScreen** | Latitude, Longitude | `validateGPSCoordinates` |
| **PhotoCaptureScreen** | Photo count (min 1) | Custom validation |
| **OwnerInfoScreen** | Location name, Owner name, Owner ID, House number, Street name | `validateRequiredText`, `validateOwnerIdNumber` |
| **UsageInfoScreen** | Land use type code | `validateLandUseTypeCode` |
| **PolygonDrawScreen** | Polygon vertices | `validatePolygonVertices` |
| **ReviewSubmitScreen** | All required fields present | Composite validation |

---

## Error Handling Pattern

All screens follow a consistent error handling pattern:

```typescript
// 1. Define validation function
const validateForm = (): boolean => {
  const newErrors: Record<string, string> = {};

  // Run validations
  const validation = validateXXX(value);
  if (!validation.isValid) {
    newErrors.fieldName = validation.errorMessage!;
  }

  // Update error state
  setErrors(newErrors);
  return Object.keys(newErrors).length === 0;
};

// 2. Check validation before submission
const handleSubmit = () => {
  if (!validateForm()) {
    Alert.alert('Lỗi xác thực', 'Vui lòng kiểm tra lại thông tin đã nhập');
    return;
  }

  // Proceed with submission
};

// 3. Display errors in UI
<Input
  value={fieldValue}
  error={errors.fieldName}
/>
{errors.fieldName && (
  <Label color="error">{errors.fieldName}</Label>
)}
```

---

## Regulatory References

Validations are based on the following Vietnamese regulations:

1. **Land Law 2013** (Luật Đất đai 2013)
   - Land use categories and codes
   - Land ownership and use rights

2. **Decree 43/2014/NĐ-CP**
   - Detailed regulations on land law implementation
   - Cadastral documentation requirements

3. **Circular 02/2015/TT-BTNMT**
   - Land survey and mapping technical regulations
   - GPS accuracy requirements
   - Cadastral record formats

4. **Circular 01/2022/TT-BCA**
   - Citizen ID card (CCCD) format and issuance
   - ID number structure and validation

---

## Testing Validation

### Valid Test Cases

```typescript
// 1. Location Identifier
validateLocationIdentifier('79-02-05-000123') // ✅ Valid
validateLocationIdentifier('01-01-01-000001') // ✅ Valid

// 2. Land Use Type Code
validateLandUseTypeCode('NNG.LUA') // ✅ Valid
validateLandUseTypeCode('PNN.DO.TT') // ✅ Valid
validateLandUseTypeCode('CSD.KH') // ✅ Valid

// 3. Owner ID Number
validateOwnerIdNumber('123456789') // ✅ Valid (9 digits CMND)
validateOwnerIdNumber('001234567890') // ✅ Valid (12 digits CCCD)

// 4. GPS Coordinates
validateGPSCoordinates(10.762622, 106.660172) // ✅ Valid (Ho Chi Minh City)
validateGPSCoordinates(21.028511, 105.804817) // ✅ Valid (Hanoi)

// 5. Phone Number
validatePhoneNumber('0901234567') // ✅ Valid
validatePhoneNumber('028-1234-5678') // ✅ Valid (formatting removed)

// 6. Polygon Vertices
validatePolygonVertices([
  { latitude: 10.762, longitude: 106.660 },
  { latitude: 10.763, longitude: 106.661 },
  { latitude: 10.764, longitude: 106.660 }
]) // ✅ Valid (3 points)
```

### Invalid Test Cases

```typescript
// 1. Location Identifier
validateLocationIdentifier('99-99-99-999999') // ❌ Province code > 96
validateLocationIdentifier('79-02-05') // ❌ Missing sequence number

// 2. Land Use Type Code
validateLandUseTypeCode('ABC.XYZ') // ❌ Invalid prefix
validateLandUseTypeCode('NNG') // ❌ No sub-category

// 3. Owner ID Number
validateOwnerIdNumber('12345678') // ❌ Only 8 digits
validateOwnerIdNumber('ABC123456789') // ❌ Contains letters

// 4. GPS Coordinates
validateGPSCoordinates(40.7128, -74.0060) // ❌ New York (outside Vietnam)
validateGPSCoordinates(0, 0) // ❌ Invalid location

// 5. Phone Number
validatePhoneNumber('0123456789') // ❌ Invalid prefix (01)
validatePhoneNumber('090123456') // ❌ Only 9 digits

// 6. Polygon Vertices
validatePolygonVertices([
  { latitude: 10.762, longitude: 106.660 },
  { latitude: 10.763, longitude: 106.661 }
]) // ❌ Only 2 points (need 3)
```

---

## Future Enhancements

### Planned Validations

1. **Cross-field Validation**
   - Verify administrative unit codes match selected province/district/commune
   - Ensure land use type is appropriate for object type

2. **Server-side Validation**
   - Duplicate location identifier detection
   - Land certificate number verification against government database

3. **Enhanced GPS Validation**
   - Check if coordinates fall within selected commune boundaries
   - Validate GPS accuracy meets minimum requirements (< 10m)

4. **Offline Validation**
   - Store reference data locally for offline validation
   - Queue validation errors for review when online

5. **Real-time Validation**
   - Validate on input change (not just on submit)
   - Progressive disclosure of errors

---

## Maintenance

### Adding New Validations

1. Add validation function to `utils/validation.ts`
2. Write JSDoc comments with examples
3. Add Vietnamese error messages
4. Update this documentation
5. Add test cases
6. Integrate into relevant screens

### Updating Existing Validations

1. Check regulatory compliance (ensure changes align with law)
2. Update validation function
3. Update error messages if needed
4. Update documentation
5. Test all affected screens
6. Notify users of changes (if breaking)

---

## Support

For questions about validation rules or regulatory compliance, refer to:
- `docs/CADASTRAL_REGULATIONS.md` - Vietnamese land and cadastral regulations
- `docs/DATA_MODEL.md` - Database schema and field definitions
- `docs/API_DOCUMENTATION.md` - Service layer validation
- `CLAUDE.md` - Project architecture and development guidelines

---

**Document Version**: 1.0
**Last Updated**: 2025-11-21
**Maintained By**: Development Team
**Status**: ✅ Complete
